name: Deploy to GitHub Pages (Branch)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      deploy_to_root:
        description: 'Déployer à la racine au lieu de /docs'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  build-and-deploy:
    name: Build and Deploy to Branch
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Build frontend
      working-directory: ./frontend
      run: npm run build
      env:
        # Activer le mode GitHub Pages pour le base path correct
        GITHUB_PAGES: 'true'
        NODE_ENV: 'production'
        # URL de l'API backend (à configurer selon votre déploiement backend)
        # Créez un secret VITE_API_URL dans Settings → Secrets and variables → Actions
        VITE_API_URL: ${{ secrets.VITE_API_URL || 'https://your-backend-url.com/api' }}
    
    # Option 1: Déployer dans le dossier /docs de la branche main (RECOMMANDÉ)
    # Si GitHub Pages est configuré pour servir depuis /docs de main
    # Cette option est active par défaut (lors d'un push automatique)
    - name: Deploy to /docs folder
      if: ${{ !github.event.inputs || !github.event.inputs.deploy_to_root || github.event.inputs.deploy_to_root == false }}
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./frontend/dist
        destination_dir: ./docs
        publish_branch: main  # Important : pousser vers main au lieu de gh-pages
        keep_files: false
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
    
    # Option 2: Déployer à la racine de la branche main
    # ⚠️ ATTENTION: Cela écrasera certains fichiers à la racine
    # Activez cette option uniquement si GitHub Pages sert depuis /root de main
    # Cette option est activée uniquement lors d'un workflow_dispatch avec deploy_to_root=true
    - name: Deploy to root of main branch
      if: ${{ github.event.inputs && github.event.inputs.deploy_to_root == 'true' }}
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./frontend/dist
        destination_dir: ./
        publish_branch: main  # Important : pousser vers main au lieu de gh-pages
        keep_files: true  # Préserve les fichiers existants
        exclude_assets: '.git,.github,backend,frontend,content,node_modules'
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'

